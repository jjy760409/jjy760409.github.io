
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AgriNexus Admin Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f8f9fa; }
    h1 { color: #198754; }
    .log { background: white; border-radius: 10px; padding: 10px; margin: 10px 0; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .uid { font-weight: bold; color: #333; }
    .msg { margin-top: 4px; }
    #loginBtn { padding: 10px 20px; font-weight: bold; background: #198754; color: white; border: none; border-radius: 8px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>ğŸ“Š AgriNexus ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
  <button id="loginBtn" onclick="login()">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸ (Google)</button>
  <div id="logs" style="margin-top:20px;"></div>
  <canvas id="langChart" width="400" height="200"></canvas>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDemoKey00000000000000000000000000",
      authDomain: "agrinexus-demo.firebaseapp.com",
      databaseURL: "https://agrinexus-demo-default-rtdb.firebaseio.com",
      projectId: "agrinexus-demo",
      storageBucket: "agrinexus-demo.appspot.com",
      messagingSenderId: "000000000000",
      appId: "1:000000000000:web:demoapp"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    function login() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then((result) => {
          const user = result.user;
          if (!user.email.endsWith("@agrinexus.com")) {
            alert("ê´€ë¦¬ì ì „ìš© ì ‘ê·¼ì…ë‹ˆë‹¤.");
            return;
          }
          document.getElementById("loginBtn").style.display = "none";
          loadLogs();
        }).catch((error) => {
          console.error(error);
          alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
        });
    }

    function loadLogs() {
      db.ref("agrinexus_chat").on("value", snapshot => {
        const logsDiv = document.getElementById("logs");
        logsDiv.innerHTML = "";
        const data = snapshot.val();
        const langStats = { en: 0, ko: 0, ja: 0 };
        for (let uid in data) {
          const userLogs = data[uid];
          for (let key in userLogs) {
            const entry = userLogs[key];
            langStats[entry.lang] = (langStats[entry.lang] || 0) + 1;
            const log = document.createElement("div");
            log.className = "log";
            log.innerHTML = `
              <div class="uid">ğŸ‘¤ ì‚¬ìš©ì: ${uid}</div>
              <div class="msg"><strong>${entry.sender}:</strong> ${entry.message}</div>
              <div class="msg">ğŸŒ ì–¸ì–´: ${entry.lang || "N/A"}</div>
            `;
            logsDiv.appendChild(log);
          }
        }
        drawChart(langStats);
      });
    }

    function drawChart(stats) {
      const ctx = document.getElementById("langChart").getContext("2d");
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['English', 'Korean', 'Japanese'],
          datasets: [{
            label: 'ì§ˆë¬¸/ì‘ë‹µ ê±´ìˆ˜',
            data: [stats.en || 0, stats.ko || 0, stats.ja || 0],
            backgroundColor: ['#4caf50', '#2196f3', '#ff9800']
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
  </script>

<div style="margin-top: 40px;">
  <h2>ğŸ§  GPT ê¸°ë°˜ ì§ˆë¬¸ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜</h2>
  <button onclick="categorizeQuestions()" style="padding:10px;background:#333;color:white;border:none;border-radius:6px;">AIë¡œ ì§ˆë¬¸ ë¶„ë¥˜</button>
  <div id="categoryResults" style="margin-top:20px;"></div>
</div>

<script>
async function categorizeQuestions() {
  const logs = document.querySelectorAll(".log .msg strong");
  const messages = Array.from(logs).map(log => log.parentElement.textContent).slice(0, 10).join("\n");

  if (!messages) {
    alert("ë¶„ì„í•  ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const prompt = `
ë‹¤ìŒ ì‚¬ìš©ì ì§ˆë¬¸ì„ ë¶„ì„í•˜ì—¬ ê° ì§ˆë¬¸ì„ ì•„ë˜ì™€ ê°™ì€ ì¹´í…Œê³ ë¦¬ ì¤‘ í•˜ë‚˜ë¡œ ë¶„ë¥˜í•´ ì£¼ì„¸ìš”:
[ì„¤ê³„, ì¬ë°°, ë¬¼ë¥˜, ìˆ˜ì¶œì…, ë¬¸ì„œ, ê¸°íƒ€]
í˜•ì‹: ì§ˆë¬¸ â†’ ì¹´í…Œê³ ë¦¬

ì§ˆë¬¸ ëª©ë¡:
${messages}
  `;

  document.getElementById("categoryResults").innerText = "AI ë¶„ì„ ì¤‘...";

  try {
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer sk-abc123xyz456def..."
      },
      body: JSON.stringify({
        model: "gpt-3.5-turbo",
        messages: [{ role: "user", content: prompt }]
      })
    });
    const data = await res.json();
    document.getElementById("categoryResults").innerText = data.choices[0].message.content;
  } catch (e) {
    console.error(e);
    document.getElementById("categoryResults").innerText = "âŒ ë¶„ì„ ì‹¤íŒ¨";
  }
}
</script>

<div style="margin-top: 30px;">
  <button onclick="exportCSV()" style="padding:8px 16px;margin-right:10px;">ğŸ“„ CSV ì €ì¥</button>
  <button onclick="exportPDF()" style="padding:8px 16px;">ğŸ§¾ PDF ì €ì¥</button>
</div>

<canvas id="categoryChart" width="400" height="200" style="margin-top:30px;"></canvas>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
function exportCSV() {
  const content = document.getElementById("categoryResults").innerText;
  const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "category_analysis.csv";
  a.click();
}

function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const content = document.getElementById("categoryResults").innerText;
  const lines = content.split('\n');
  lines.forEach((line, i) => doc.text(line, 10, 10 + i * 10));
  doc.save("category_analysis.pdf");
}

function drawCategoryChartFromText() {
  const text = document.getElementById("categoryResults").innerText;
  const lines = text.split("\n");
  const counts = {
    ì„¤ê³„: 0, ì¬ë°°: 0, ë¬¼ë¥˜: 0, ìˆ˜ì¶œì…: 0, ë¬¸ì„œ: 0, ê¸°íƒ€: 0
  };
  lines.forEach(line => {
    for (let key in counts) {
      if (line.includes(key)) counts[key]++;
    }
  });

  const ctx = document.getElementById("categoryChart").getContext("2d");
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Object.keys(counts),
      datasets: [{
        label: 'ì¹´í…Œê³ ë¦¬ë³„ ì§ˆë¬¸ ìˆ˜',
        data: Object.values(counts),
        backgroundColor: '#198754'
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}
</script>

<script>
const observeCategory = new MutationObserver(drawCategoryChartFromText);
observeCategory.observe(document.getElementById("categoryResults"), { childList: true });
</script>

</body>


</html>
