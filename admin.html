
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AgriNexus Admin Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f8f9fa; }
    h1 { color: #198754; }
    .log { background: white; border-radius: 10px; padding: 10px; margin: 10px 0; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .uid { font-weight: bold; color: #333; }
    .msg { margin-top: 4px; }
    #loginBtn { padding: 10px 20px; font-weight: bold; background: #198754; color: white; border: none; border-radius: 8px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>📊 AgriNexus 관리자 대시보드</h1>
  <button id="loginBtn" onclick="login()">🔐 관리자 로그인 (Google)</button>
  <div id="logs" style="margin-top:20px;"></div>
  <canvas id="langChart" width="400" height="200"></canvas>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDemoKey00000000000000000000000000",
      authDomain: "agrinexus-demo.firebaseapp.com",
      databaseURL: "https://agrinexus-demo-default-rtdb.firebaseio.com",
      projectId: "agrinexus-demo",
      storageBucket: "agrinexus-demo.appspot.com",
      messagingSenderId: "000000000000",
      appId: "1:000000000000:web:demoapp"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    function login() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then((result) => {
          const user = result.user;
          if (!user.email.endsWith("@agrinexus.com")) {
            alert("관리자 전용 접근입니다.");
            return;
          }
          document.getElementById("loginBtn").style.display = "none";
          loadLogs();
        }).catch((error) => {
          console.error(error);
          alert("로그인 실패: " + error.message);
        });
    }

    function loadLogs() {
      db.ref("agrinexus_chat").on("value", snapshot => {
        const logsDiv = document.getElementById("logs");
        logsDiv.innerHTML = "";
        const data = snapshot.val();
        const langStats = { en: 0, ko: 0, ja: 0 };
        for (let uid in data) {
          const userLogs = data[uid];
          for (let key in userLogs) {
            const entry = userLogs[key];
            langStats[entry.lang] = (langStats[entry.lang] || 0) + 1;
            const log = document.createElement("div");
            log.className = "log";
            log.innerHTML = `
              <div class="uid">👤 사용자: ${uid}</div>
              <div class="msg"><strong>${entry.sender}:</strong> ${entry.message}</div>
              <div class="msg">🌐 언어: ${entry.lang || "N/A"}</div>
            `;
            logsDiv.appendChild(log);
          }
        }
        drawChart(langStats);
      });
    }

    function drawChart(stats) {
      const ctx = document.getElementById("langChart").getContext("2d");
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['English', 'Korean', 'Japanese'],
          datasets: [{
            label: '질문/응답 건수',
            data: [stats.en || 0, stats.ko || 0, stats.ja || 0],
            backgroundColor: ['#4caf50', '#2196f3', '#ff9800']
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
  </script>

<div style="margin-top: 40px;">
  <h2>🧠 GPT 기반 질문 카테고리 분류</h2>
  <button onclick="categorizeQuestions()" style="padding:10px;background:#333;color:white;border:none;border-radius:6px;">AI로 질문 분류</button>
  <div id="categoryResults" style="margin-top:20px;"></div>
</div>

<script>
async function categorizeQuestions() {
  const logs = document.querySelectorAll(".log .msg strong");
  const messages = Array.from(logs).map(log => log.parentElement.textContent).slice(0, 10).join("\n");

  if (!messages) {
    alert("분석할 질문이 없습니다.");
    return;
  }

  const prompt = `
다음 사용자 질문을 분석하여 각 질문을 아래와 같은 카테고리 중 하나로 분류해 주세요:
[설계, 재배, 물류, 수출입, 문서, 기타]
형식: 질문 → 카테고리

질문 목록:
${messages}
  `;

  document.getElementById("categoryResults").innerText = "AI 분석 중...";

  try {
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer sk-abc123xyz456def..."
      },
      body: JSON.stringify({
        model: "gpt-3.5-turbo",
        messages: [{ role: "user", content: prompt }]
      })
    });
    const data = await res.json();
    document.getElementById("categoryResults").innerText = data.choices[0].message.content;
  } catch (e) {
    console.error(e);
    document.getElementById("categoryResults").innerText = "❌ 분석 실패";
  }
}
</script>

<div style="margin-top: 30px;">
  <button onclick="exportCSV()" style="padding:8px 16px;margin-right:10px;">📄 CSV 저장</button>
  <button onclick="exportPDF()" style="padding:8px 16px;">🧾 PDF 저장</button>
</div>

<canvas id="categoryChart" width="400" height="200" style="margin-top:30px;"></canvas>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
function exportCSV() {
  const content = document.getElementById("categoryResults").innerText;
  const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "category_analysis.csv";
  a.click();
}

function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const content = document.getElementById("categoryResults").innerText;
  const lines = content.split('\n');
  lines.forEach((line, i) => doc.text(line, 10, 10 + i * 10));
  doc.save("category_analysis.pdf");
}

function drawCategoryChartFromText() {
  const text = document.getElementById("categoryResults").innerText;
  const lines = text.split("\n");
  const counts = {
    설계: 0, 재배: 0, 물류: 0, 수출입: 0, 문서: 0, 기타: 0
  };
  lines.forEach(line => {
    for (let key in counts) {
      if (line.includes(key)) counts[key]++;
    }
  });

  const ctx = document.getElementById("categoryChart").getContext("2d");
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Object.keys(counts),
      datasets: [{
        label: '카테고리별 질문 수',
        data: Object.values(counts),
        backgroundColor: '#198754'
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}
</script>

<script>
const observeCategory = new MutationObserver(drawCategoryChartFromText);
observeCategory.observe(document.getElementById("categoryResults"), { childList: true });
</script>


<div style="margin-top: 40px;">
  <h2>🔎 유사 질문 추천</h2>
  <input type="text" id="similarInput" placeholder="비교할 질문을 입력하세요" style="width:80%;padding:8px;">
  <button onclick="recommendSimilar()" style="padding:8px 16px;">추천 보기</button>
  <div id="similarResults" style="margin-top:15px;font-size:0.9rem;"></div>
</div>

<script>
async function recommendSimilar() {
  const query = document.getElementById("similarInput").value.trim();
  if (!query) return alert("비교할 질문을 입력해 주세요.");

  const allLogs = Array.from(document.querySelectorAll(".log .msg strong"))
    .map(log => log.parentElement.textContent)
    .filter(q => !q.includes("AgriBot"))
    .slice(0, 20).join("\n");

  const prompt = `
아래에 기존 질문들이 있습니다. 이 중에서 입력된 질문과 가장 유사한 질문 3개를 찾아 추천해 주세요.

입력 질문:
"${query}"

기존 질문들:
${allLogs}
`;

  document.getElementById("similarResults").innerText = "🔄 유사 질문 분석 중...";

  try {
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer sk-abc123xyz456def..."
      },
      body: JSON.stringify({
        model: "gpt-3.5-turbo",
        messages: [{ role: "user", content: prompt }]
      })
    });
    const data = await res.json();
    document.getElementById("similarResults").innerText = "✅ 추천:
" + data.choices[0].message.content;
  } catch (e) {
    console.error(e);
    document.getElementById("similarResults").innerText = "❌ 추천 실패";
  }
}
</script>


<hr style="margin:40px 0;">

<h2>📂 카테고리 필터링</h2>
<select id="categoryFilter" onchange="filterByCategory()" style="padding:6px;">
  <option value="all">전체</option>
  <option value="설계">설계</option>
  <option value="재배">재배</option>
  <option value="물류">물류</option>
  <option value="수출입">수출입</option>
  <option value="문서">문서</option>
  <option value="기타">기타</option>
</select>

<script>
function filterByCategory() {
  const value = document.getElementById("categoryFilter").value;
  const lines = document.getElementById("categoryResults").innerText.split("\n");
  const filtered = value === "all" ? lines : lines.filter(l => l.includes(value));
  document.getElementById("categoryResults").innerText = filtered.join("\n");
}
</script>

<hr style="margin:40px 0;">

<h2>📆 이용 통계 (기간 필터)</h2>
<select id="periodFilter" onchange="filterStatsByPeriod()" style="padding:6px;">
  <option value="all">전체</option>
  <option value="day">최근 1일</option>
  <option value="week">최근 7일</option>
</select>

<div id="periodStats" style="margin-top:10px;"></div>

<script>
function filterStatsByPeriod() {
  const range = document.getElementById("periodFilter").value;
  const logs = Array.from(document.querySelectorAll(".log .msg")).map(e => ({
    text: e.innerText,
    time: Date.now() // simulate time since Firebase does not show timestamps here
  }));
  let filtered = logs;
  if (range === "day") {
    const limit = Date.now() - 24*60*60*1000;
    filtered = logs.filter(l => l.time > limit);
  } else if (range === "week") {
    const limit = Date.now() - 7*24*60*60*1000;
    filtered = logs.filter(l => l.time > limit);
  }
  document.getElementById("periodStats").innerText = "총 " + filtered.length + "건 분석됨 (임시 시뮬레이션 기준)";
}
</script>

<hr style="margin:40px 0;">

<h2>📈 질문 순위 기반 추천</h2>
<button onclick="showTopQuestions()" style="padding:8px 16px;">상위 질문 보기</button>
<div id="topQuestions" style="margin-top:10px;font-size:0.9rem;"></div>

<script>
function showTopQuestions() {
  const questions = Array.from(document.querySelectorAll(".log .msg")).map(e => e.innerText.trim());
  const freq = {};
  questions.forEach(q => {
    if (!q.includes("AgriBot")) {
      freq[q] = (freq[q] || 0) + 1;
    }
  });
  const sorted = Object.entries(freq).sort((a,b) => b[1] - a[1]).slice(0, 5);
  const topText = sorted.map(([q,c], i) => `#${i+1} (${c}회): ${q}`).join("\n");
  document.getElementById("topQuestions").innerText = topText;
}
</script>


<hr style="margin:40px 0;">

<h2>🧪 GPT 분류 정확도 피드백</h2>
<p>아래 버튼을 눌러 GPT 분류 결과에 대한 정확도를 1~5점으로 평가해 주세요.</p>
<div id="feedbackRating">
  <button onclick="submitFeedback(1)">⭐</button>
  <button onclick="submitFeedback(2)">⭐⭐</button>
  <button onclick="submitFeedback(3)">⭐⭐⭐</button>
  <button onclick="submitFeedback(4)">⭐⭐⭐⭐</button>
  <button onclick="submitFeedback(5)">⭐⭐⭐⭐⭐</button>
</div>
<div id="feedbackStatus" style="margin-top:10px;color:green;"></div>

<script>
function submitFeedback(score) {
  const uid = "admin-feedback";
  const time = Date.now();
  const feedback = {
    score,
    timestamp: time
  };
  firebase.database().ref("agrinexus_feedback/" + uid + "/" + time).set(feedback);
  document.getElementById("feedbackStatus").innerText = `감사합니다. (${score}점 제출됨)`;
}
</script>

<hr style="margin:40px 0;">

<h2>🔄 Google Sheets 연동</h2>
<p>분석 결과 또는 질문 로그를 Google Sheets로 내보내고 싶으신가요?</p>
<button onclick="exportToSheets()" style="padding:8px 16px;">📤 시트로 내보내기</button>
<div id="sheetExportStatus" style="margin-top:10px;font-size:0.9rem;"></div>

<script>
async function exportToSheets() {
  document.getElementById("sheetExportStatus").innerText = "🔄 Google Sheets로 내보내는 중...";
  try {
    // 아래 요청은 실제 연동 시 서버리스 Firebase Functions 또는 AppScript API 필요
    // 여기서는 데모 URL로 대체
    const response = await fetch("https://sheet.googleapis.com/v4/spreadsheets/fake-export-endpoint", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer FAKE_API_KEY"
      },
      body: JSON.stringify({
        values: document.getElementById("categoryResults").innerText.split("\n")
      })
    });
    if (response.ok) {
      document.getElementById("sheetExportStatus").innerText = "✅ Google Sheets로 성공적으로 내보내졌습니다.";
    } else {
      throw new Error("내보내기 실패");
    }
  } catch (e) {
    document.getElementById("sheetExportStatus").innerText = "❌ Google Sheets 연동에 실패했습니다. (API 설정 필요)";
  }
}
</script>


<hr style="margin:40px 0;">
<h2>📊 피드백 점수 통계 시각화</h2>
<button onclick="drawFeedbackChart()" style="padding:8px 16px;">📈 통계 보기</button>
<canvas id="feedbackChart" width="400" height="200" style="margin-top:20px;"></canvas>

<script>
function drawFeedbackChart() {
  firebase.database().ref("agrinexus_feedback/admin-feedback").once("value", snapshot => {
    const data = snapshot.val();
    const scores = [0, 0, 0, 0, 0];
    for (let key in data) {
      const s = data[key].score;
      if (s >= 1 && s <= 5) scores[s - 1]++;
    }
    const ctx = document.getElementById("feedbackChart").getContext("2d");
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['⭐1', '⭐2', '⭐3', '⭐4', '⭐5'],
        datasets: [{
          label: '제출된 피드백 수',
          data: scores,
          backgroundColor: '#ffc107'
        }]
      },
      options: {
        scales: { y: { beginAtZero: true } }
      }
    });
  });
}
</script>

<hr style="margin:40px 0;">
<h2>📤 실연동용 Google Sheets App Script 코드</h2>
<pre style="background:#eee;padding:10px;font-size:0.8rem;overflow-x:auto;">
function doPost(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var data = JSON.parse(e.postData.contents);
  data.values.forEach(row => {
    sheet.appendRow([new Date(), row]);
  });
  return ContentService.createTextOutput("success");
}
</pre>

<p>📝 위 코드를 Google Apps Script에 붙여넣고 웹앱으로 배포하세요.<br>
사용 권한: 누구나 접근 / POST 요청 허용</p>

<hr style="margin:40px 0;">
<h2>🧠 사용자 질문 기반 AI 보정 요청</h2>
<p>GPT가 부정확한 분류를 했다면 아래에 보정 요청을 입력해 주세요.</p>
<textarea id="aiCorrection" rows="3" style="width:100%;padding:8px;"></textarea><br>
<button onclick="submitCorrection()" style="margin-top:10px;padding:8px 16px;">보정 요청 제출</button>
<div id="correctionStatus" style="margin-top:10px;color:green;"></div>

<script>
function submitCorrection() {
  const text = document.getElementById("aiCorrection").value.trim();
  if (!text) return alert("내용을 입력해 주세요.");
  const time = Date.now();
  firebase.database().ref("agrinexus_training").push({
    correction: text,
    timestamp: time
  });
  document.getElementById("correctionStatus").innerText = "✅ 보정 요청이 저장되었습니다.";
  document.getElementById("aiCorrection").value = "";
}
</script>


<hr style="margin:40px 0;">
<h2>📄 수출입 문서 및 계약서 자동화 시스템</h2>
<p>수출입에 필요한 문서 생성, 번역, 진단, 계약서 오류 검토 등 자동화 지원.</p>
<button onclick="startAutoDocumentSystem()" style="padding:10px 20px;">🚀 자동 문서 분석 실행</button>
<div id="docAutomationResults" style="margin-top:15px;font-size:0.9rem;"></div>

<script>
async function startAutoDocumentSystem() {
  const prompt = `
다음과 같은 기능을 자동화합니다:
1. 수출입 문서/계약서에 대한 자동 생성 및 국가별 언어 번역
2. 법률적 표현과 항목의 누락 여부 자동 진단
3. 잘못된 작성 예시 감지 및 추천 수정안 제시
4. 사용자 질문에 기반한 CS 대응 자동화

예시 문서:
- 수출계약서, 송장, 세관신고서 등
- 작성 오류 예: 서명 누락, 날짜 오류, 문장 불일치

위 기능을 기반으로 스마트 문서 시스템 보고서를 생성하세요. 각 항목은 상세하게 기술해 주세요.
  `;

  document.getElementById("docAutomationResults").innerText = "📄 자동화 보고서 생성 중...";

  try {
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer sk-abc123xyz456def..."
      },
      body: JSON.stringify({
        model: "gpt-3.5-turbo",
        messages: [{ role: "user", content: prompt }]
      })
    });
    const data = await res.json();
    document.getElementById("docAutomationResults").innerText = "✅ 자동화 분석 결과:
" + data.choices[0].message.content;
  } catch (e) {
    console.error(e);
    document.getElementById("docAutomationResults").innerText = "❌ 자동 분석 실패. 다시 시도해 주세요.";
  }
}
</script>

</body>







</html>
